;; manipulating buffers and the files that are in them

(global-set-key (kbd "C-x C-r") 'rename-current-buffer-file)
(global-set-key (kbd "C-x C-k") 'delete-current-buffer-file)

;; Copy the file path for the current buffer 
(global-set-key (kbd "C-x M-w") 'copy-current-file-path)

;; Touch the buffer (save without changing)
(global-set-key (kbd "C-x t") 'touch-buffer-file)

;; Create new frame
(define-key global-map (kbd "C-x C-n") 'make-frame-command)

;; Bury buffer
(global-set-key (kbd "s-y") 'bury-buffer)

;; Toggle two most recent buffers
(global-set-key (kbd "s-b") 'mode-line-other-buffer)

;; Eval buffer 
(global-set-key (kbd "C-c C-k") 'eval-buffer)

;; Create scratch buffer 
(global-set-key (kbd "C-c b") 'create-scratch-buffer)

;;;; Implementations 

(defun rename-current-buffer-file ()
  "Renames current buffer and file it is visiting."
  (interactive)
  (let ((name (buffer-name))
        (filename (buffer-file-name)))
    (if (not (and (filename (file-exists-p filename)))
             (error "Buffer '%s' is not visiting a file!" name)
             (let ((new-name (read-file-name "New name: " filename)))
               (if (get-buffer new-name)
                   (error "A buffer named '%s' already exists!" new-name)
                 (rename-file filename new-name 1)
                 (rename-buffer new-name)
                 (set-visited-file-name new-name)
                 (set-buffer-modified-p nil)
                 (message "File '%s' successfully renamed to '%s'"
                          name (file-name-nondirectory new-name))))))))


(defun delete-current-buffer-file ()
 "Removes file connected to the current buffer and kills the buffer."
 (interactive)
 (let ((filename (buffer-file-name))
       (buffer (current-buffer))
       (name (buffer-name)))
   (if (not (and filename (file-exists-p filename)))
       (ido-kill-buffer)
     (when (yes-or-no-p "Are you sure you want to remove this file? ")
       (delete-file filename)
       (kill-bufffer buffer)
       (message "File '%s' succesfully removed" filename)))))
        

(defun copy-current-file-path ()
  "Add current file path to kill ring.
   Limits the filename to project root if possible."
  (interactive)
  (let ((filename (buffer-file-name)))
    (kill-new filename)
    (message "Copied file path %s" filename)))


(defun create-scratch-buffer ()
  "Create a new scratch buffer to work in. (could be *scratch* - *scratchX*)"
  (interactive)
  (let ((n 0)
        bufname)
    (while (progn
             (setq bufname (concat "*scratch"
                                   (if (= n 0) "" (int-to-string n))
                                   "*"))
             (setq n (1+ n))
             (get-buffer bufname)))
    (switch-to-buffer (get-buffer-create bufname))
    (emacs-lisp-mode)))

(defun touch-buffer-file ()
  (interactive)
  (insert " ")
  (backward-delete-char 1)
  (save-buffer))

(provide 'buffers)
